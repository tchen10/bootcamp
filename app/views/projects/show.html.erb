<div class="span12">
  <h1><%= @project.title %></h1>
</div>

  <div class="well span4">
    <p>
      <b>Status:</b>
        <%= @project.recent_status.try(:description) %> <p>(updated: <%= @project.recent_status.try(:date) %>)</p>
      <%= form_tag(statuses_url, method: 'post') do %>
        <%= hidden_field_tag :project_id, @project.id %>
        <div id="divdateselect" style="display: none;">
        <%= date_select :date, default:Date.today %>
        </div>
        <%= text_field_tag :description, nil, :placeholder => "What's the status?" %>
      <% end %>
    </p>

    <p>
      <b>Due date:</b>
      <%= @project.due_date %>
    </p>

    <p>
      <b>Description:</b>
      <%= @project.description %>
    </p>

    <p>
      <b>Team:</b>
      <ul>
        <% @project.users.each do |user| %>
          <li><%= link_to user.name, user_url(user) %>
            <%= link_to 'Delete'.html_safe, assignment_url(Assignment.find_by_user_id_and_project_id(user.id, @project.id)), method: 'delete', data: { confirm: "Delete Team Member?" }, :class => "btn btn-mini", :id => "delete_team" %>
          </li>
        <% end %>
      </ul>
      <p>
      <%= form_tag(assignments_url, method: 'post', :remote => true, :id => "team_form") do %>
        <%= select_tag :user_id, options_from_collection_for_select(User.order('name').all, :id, :name), :include_blank => true %>
        <%= hidden_field_tag :project_id, @project.id %><%= submit_tag "Add To Team", :class => "btn btn-success" %>
      <% end %>
      </p>
    </p>

    <p>
      <b>Date created:</b>
      <%= @project.date_created %>
    </p>

    <p>
      <%= link_to 'Edit', edit_project_url(@project.id), :class => "btn btn-mini" %>  <%= link_to 'Delete Project', project_url(@project.id), :class => "btn btn-mini", method: 'delete', data: { confirm: "Do you really want to delete this project?" } %>
    </p>
  </div>
<div class="span10">
  <div class="well">
    <h4><b>Milestones:</b></h4>
    <table class="table table-hover">
      <thead>
        <tr>
          <th>Title</th>
          <th>Due date</th>
          <th>Tasks Completed</th>
          <th>Still To Go</th>
          <th></th>
          <th></th>
        </tr>
      </thead>

      <tbody>
      <% @project.milestones.order('due_date').all.each do |milestone| %>
        <% if milestone.due_date <= Date.today %>
          <tr class="error">
        <% else %>
          <tr>
        <% end %>
          <td><%= link_to milestone.title, milestone_url(milestone) %></td>
          <td><%= milestone.due_date %></td>
          <td><%= milestone.tasks.complete.count %> of <%= milestone.tasks.all.count %></td>
          <td><%= milestone.tasks.incomplete.count %></td>
          <td><%= link_to 'Edit', edit_milestone_url(milestone), :class => "btn btn-mini" %></td>
          <td><%= link_to 'Delete', milestone_url(milestone.id), :class => "btn btn-mini", method: 'delete', data: { confirm: "Do you really want to delete this milestone?" } %>
        </tr>
      <% end %>
      </tbody>
    </table>
    <p><button class="btn btn-success", data-toggle="collapse", data-target="#quick_form">+</button></p>
    <div id="quick_form", class="collapse">
      <% @milestone = Milestone.new %>
      <%= form_for @milestone do |f| %>
        <%= f.hidden_field :project_id, :value => @project.id %>
        <div class="span5">
        <p><%= f.text_field :title, :placeholder => "Title" %></p>
        </div>
        <div id="divdateselect" style="display: none;">
        <%= f.date_select :date_created, default:Date.today %>
        </div>
        <div class="span5">
        <%= f.label :due_date, "Due Date:" %>
        <p><%= f.date_select :due_date, :default => Date.today+1, :order => [:day, :month, :year], :start_year => Time.now.year, :end_year => Time.now.year+2 %></p>
        </div>
        <div class="span5">
        <%= f.submit "Set Milestone", :class => "btn btn-mini" %>
        </div>
      <% end %>
    </div>
  </div>

  <div class="well">
    <h4><b>Tasks:</b></h4>
    <table class="table table-hover">
      <thead>
        <tr>
          <th>Description</th>
          <th>Assigned To</th>
          <th>Due Date</th>
          <th>Milestone</th>
          <th>Status (Click to Change)</th>
          <th>Update</th>
        </tr>
      </thead>
      <tbody>
      <% @project.tasks.incomplete.order('due_date').all.each do |task| %>
      <% if task.due_date <= Date.today %>
        <tr class="error">
      <% else %>
        <tr>
      <% end %>
        <td><%= link_to task.description, task_url(task.id) %></td>
        <td><%= link_to task.user.name, user_url(task.user_id) %></td>
        <td><%= task.due_date %></td>
        <td><%= link_to task.milestone.title, milestone_url(task.milestone.id) %></td>
        <td><span name="status"><%= task.status %></span>
          <span name="newstatus">
            <% @task = Task.find_by_id(task.id) %>
            <%= form_for @task do |f| %>
              <%= f.hidden_field :project_id %>
              <%= f.hidden_field :milestone_id %>
              <%= f.hidden_field :description %>
            <div id="divdateselect" style="display: none;">
              <%= f.date_select :date_created %>
              <%= f.date_select :due_date %>
              <%= f.date_select :date_completed %>
            </div>
            <%= f.hidden_field :user_id %>
            <%= f.text_field :status, {:placeholder => "Status?", :class => "input-mini"} %>
            <%= f.hidden_field :complete, :value => "incomplete" %>
            <%= f.check_box :complete, {}, "complete", "incomplete"  %>
            <%= f.submit "Update", :class => "btn btn-mini" %>
            <% end %>
          </span>
        </td>
        <td><%= link_to 'Edit', edit_task_url(task), :class => "btn btn-mini" %></td>
      </tr>
      <% end %>
      </tbody>
    </table>
    <p><button class="btn btn-success", data-toggle="collapse", data-target="#quick_taskform">+</button></p>
      <div id="quick_taskform", class="collapse">
        <% @task = Task.new %>
        <%= form_for @task do |f| %>
        <%= f.hidden_field :project_id, :value => @project.id %>
        <div class="span5">
          <%= f.collection_select :milestone_id, @project.milestones.order('title').all, :id, :title %>
          <%= f.text_field :description, :placeholder => "Description" %>
        </div>
        <div id="divdateselect" style="display: none;">
          <%= f.date_select :date_created, default:Date.today %>
          <%= f.date_select :date_completed, default:Date.today %>
        </div>
        <div class="span5">
          <%= f.label :due_date, "Due Date:" %>
          <%= f.date_select :due_date, :default => Date.today+1, :order => [:day, :month, :year], :start_year => Time.now.year, :end_year => Time.now.year+2 %>
        </div>
        <div class="span5">
        <%= label_tag :user_id, "Assigned To:" %>
        <%= f.collection_select :user_id, User.order('name').all, :id, :name %>
        </div>
        <%= f.hidden_field :status, :value => "Update Status!" %>
        <%= f.hidden_field :complete, :value => "incomplete" %>

        <div class="span5">
        <%= f.submit "Create Task", :class => "btn btn-mini" %>
        </div>
        <% end %>
      </div>
    </div>

  <div class="well">
    <h4><b>Completed Tasks:</b></h4>
      <table class="table table-hover">
    <thead>
      <tr>
        <th>Description</th>
        <th>Assigned to</th>
        <th>Due Date</th>
        <th>Milestone</th>
        <th>Date Completed</th>
        <th></th>
      </tr>
    </thead>

    <tbody>
    <% @project.tasks.complete.order('due_date').all.each do |task| %>
      <tr>
        <td><%= link_to task.description, task_url(task.id) %></td>
        <td><%= link_to task.user.name, user_url(task.user_id) %></td>
        <td><%= task.due_date %></td>
        <td><%= link_to task.milestone.title, milestone_url(task.milestone.id) %></td>
        <td><%= task.date_completed %></td>
        <td><%= link_to 'Delete', task_url(task), :class => "btn btn-mini", method: 'delete', data: { confirm: "Do you really want to delete this task?" } %></td>

      </tr>
    <% end %>
    </tbody>
    </div>
</div>

<script type="text/javascript">
  $('span[name=newstatus]').hide();
  $('span[name=status]').click(function() {
    $(this).hide();
  $('span[name=newstatus]', $(this).closest('td')).show();
  });
</script>


